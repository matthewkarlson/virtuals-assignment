# Virtual Protocol: Comprehensive Smart Contract Architecture Guide

    > Kindly generated by Mister Claude

## Table of Contents
1. [Overview](#overview)
2. [Core Architecture](#core-architecture)
3. [Agent Creation Flow](#agent-creation-flow)
4. [Bonding Curve & AMM Graduation](#bonding-curve--amm-graduation)
5. [Tokenomics & Staking](#tokenomics--staking)
6. [Governance System](#governance-system)
7. [Reward Distribution](#reward-distribution)
8. [Contribution System](#contribution-system)
9. [Tax & Fee Management](#tax--fee-management)
10. [Contract Interactions](#contract-interactions)

## Overview

Virtual Protocol is a decentralized ecosystem for creating and managing AI agents with their own tokens, governance, and economic systems. The protocol enables users to create AI agents that graduate from bonding curves to full AMM trading, with sophisticated reward distribution and governance mechanisms.

## Core Architecture

### Primary Components

1. **Agent Factory** - Creates and manages AI agents
2. **Bonding Curve System** - Initial price discovery mechanism
3. **AMM Integration** - Uniswap V2 integration for mature agents
4. **Governance DAOs** - Agent-specific governance
5. **Reward Distribution** - Multi-tier reward system
6. **Contribution System** - NFT-based contribution tracking

## Agent Creation Flow

### 1. Agent Proposal

Users can propose new agents through the `AgentFactory` contract:

```solidity
// contracts/virtualPersona/AgentFactoryV4.sol:160-180
function proposeAgent(
    string memory name,
    string memory symbol,
    string memory tokenURI,
    uint8[] memory cores,
    bytes32 tbaSalt,
    address tbaImplementation,
    uint32 daoVotingPeriod,
    uint256 daoThreshold
) external returns (uint256)
```

**Process:**
1. User pays application threshold in VIRTUAL tokens
2. Application is stored with `ApplicationStatus.Active`
3. Returns unique application ID

### 2. Agent Execution

Once approved, agents are created through a comprehensive bootstrap process:

```solidity
// contracts/virtualPersona/AgentFactoryV4.sol:247-330
function _executeApplication(uint256 id, bool canStake, bytes memory tokenSupplyParams_) internal
```

**Components Created (C1-C7):**
- **C1**: Agent Token (ERC20 with bonding curve mechanics)
- **C2**: LP Pool + Initial liquidity
- **C3**: Agent veToken (voting escrow token for staking)
- **C4**: Agent DAO (governance contract)
- **C5**: Agent NFT (ERC721 representing the agent)
- **C6**: TBA (Token Bound Account via ERC6551)
- **C7**: Initial liquidity staking

## Bonding Curve & AMM Graduation

### Bonding Curve Mechanics

The bonding curve system provides initial price discovery for new agent tokens:

```solidity
// contracts/fun/Bonding.sol:31
uint256 public constant K = 3_000_000_000_000;
```

**Launch Process:**
```solidity
// contracts/fun/Bonding.sol:160-230
function launch(
    string memory _name,
    string memory _ticker,
    uint8[] memory cores,
    string memory desc,
    string memory img,
    string[4] memory urls,
    uint256 purchaseAmount
) external returns (address, address, uint256)
```

### Graduation Mechanism

Agents graduate to Uniswap when reserves hit the graduation threshold:

```solidity
// contracts/fun/Bonding.sol:350-380
function _openTradingOnUniswap(address tokenAddress) private
```

**Graduation Trigger:**
```solidity
// contracts/fun/Bonding.sol:320-325
if (newReserveA <= gradThreshold && tokenInfo[tokenAddress].trading) {
    _openTradingOnUniswap(tokenAddress);
}
```

**Graduation Process:**
1. Bonding curve trading stops
2. Liquidity migrates to Uniswap V2
3. Agent token is created via `AgentFactory`
4. Original fun tokens can be unwrapped for agent tokens
